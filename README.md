# Калькулятор на языке Golang

Калькулятор основан на взаимодействии двух серверов: оркестратора и агента, где оркестратор делит входное математическое выражение на отдельные задачи, а агент эти задачи вычисляет.

Взаимодействие оркестратора и агента происходит по gRPC, а связь пользователя с оркестратором - по HTTP. 

Все выражения сохраняются в базе данных SQL, доступ к ним доступен после перезагрузки калькулятора.

## Запуск

1. Клонируйте библиотеку через git clone 

2. Перейдите в папку с программой (calc_go_final) в двух cmd-терминалах:
```
cd calc_go_final
```

3.  В одном из них введите команду, которая запустит gRPC-сервер агента:
```
go run ./cmd/agent/main.go
```

4. В другом введите команду, которая подключит оркестратор к gRPC-серверу агента и запустит http-сервер для взаимодействия с пользователем:
```
go run ./cmd/orkestrator/main.go
```

4. Откройте cmd-терминал и проведите регистрацию:
```
curl -X POST http://localhost:8081/api/v1/register -H "Content-Type:application/json" -d "{\"login\":\"user_1\",\"password\":\"123\"}"
```

5. Затем необходимо войти под логином и паролем:
```
curl -X POST http://localhost:8081/api/v1/login -H "Content-Type:application/json" -d "{\"login\":\"user_1\",\"password\":\"123\"}"
```

6. Выданный токен скопируйте (без кавычек), он будет использоваться далее при каждом запросе

7. Чтобы вычислить выражение используйте, вставив токен, этот запрос:
```
curl -X POST http://localhost:8081/api/v1/calculate -H "Content-Type:application/json" -H "Authorization:<token>" -d "{\"expression\":\"1+2+3+4\"}"
```

8. Чтобы проверить параллельность запросов от разных пользователей, проделайте те же операции, но в другом терминале, зарегистрировав другого пользователя. Для второго пользователя можно использовать запрос:
```
curl -X POST http://localhost:8081/api/v1/calculate -H "Content-Type:application/json" -H "Authorization:<token>" -d "{\"expression\":\"5-4-3-2-1\"}"
```

9. Далее используйте этот запрос, использовав сначала токен первого пользователя, а затем второго
```
curl -X POST http://localhost:8081/api/v1/expressions -H "Authorization:<token>"
```

10. Вы увидите, что для первого пользователя будет показана информация о выражении 1+2+3+4+5, а для второго 5-4-3-2-1

11. Скопируйте любой ID выражения, и вставьте вместе с токеном этого же пользователя в данный запрос:
```
curl -X POST http://localhost:8081/api/v1/expression/<id> -H "Authorization:<token>"
```

12. Чтобы очистить базу данных выражения используйте с соответствующим токеном:
```
curl -X POST http://localhost:8081/api/v1/clear -H "Authorization:<token>"
```

13. Проверить, очистилась ли база данных, можно запросом выражений. Должна вернуться пустая табличка:
```
curl -X POST http://localhost:8081/api/v1/expressions -H "Authorization:<token>"
```

14. Чтобы проверить сохранность выражений (где они не были удалены) после перезагрузки калькулятора, рекомендуется завершить процесс (Ctrl+C) в окнах, где запускались сервера, а затем запустить их снова и повторно получить выражения (можно с теми же токенами)

## Примеры запросов
```
curl -X POST http://localhost:8081/api/v1/calculate -H "Content-Type:application/json" -H "Authorization:<token>" -d "{\"expression\":\"1+2+3\"}"
```
Результат: 6

```
curl -X POST http://localhost:8081/api/v1/calculate -H "Content-Type:application/json" -H "Authorization:<token>" -d "{\"expression\":\"1*2+(3+4-5+(6/2))\"}"
```
Результат: 1

```
curl -X POST http://localhost:8081/api/v1/calculate -H "Content-Type:application/json" -H "Authorization:<token>" -d "{\"expression\":\"1+2/0\"}"
```
Результат: division by zero

```
curl -X POST http://localhost:8081/api/v1/calculate -H "Content-Type:application/json" -H "Authorization:<token>" -d "{\"expression\":\"1+2+a\"}"
```
Результат: unexpected symbol

```
curl -X POST http://localhost:8081/api/v1/calculate -H "Content-Type:application/json" -H "Authorization:<token>" -d "{\"expression\":\"1++2\"}"
```
Результат: incorrect expression


## Принцип работы

В калькуляторе взаимодействуют пользователь, оркестратор и агент.
[[readme_assets/Scheme.png]]

Для того, чтобы пользователь смог взаимодействовать с калькулятором, ему необходимо зарегистрироваться и получить по своему логину и паролю токен. Регистрация происходит по ручке "/api/v1/register", вход по ручке "/api/v1/login". Данные о пользователях сохраняются в СУБД (пароли хешируются).

После входа пользователю показывается JWT-токен, который необходимо использовать при каждом следующем запросе. Проверка токена при запросах реализована через middleware.

Оркестратор принимает от пользователя математическое выражение для решения, добавляет его в базу данных SQLlite, присваивая ID, и представляет в виде обратной польской записи. Затем начинается деление выражения на простейшие выражения из двух аргументов и знака операции. Это простейшее выражение по gRPC отправляется агенту, который запускает COMPUTING_POWER воркеров-калькуляторов. Результат возвращается оркестратору. 

Такие простейшие выражения отправляются до тех пор, пока всё выражение не будет пересчитано. После этого статус выражения в базе данных меняется с pending на completed (или failed, если произошла какая-либо ошибка, к примеру деление на ноль), данные о результате/ошибке выводятся пользователю и также записываются в СУБД.

В процессе работы можно просмотреть хранилище выражений, и найти выражение по ID с помощью запросов end-поинтами "/api/v1/expressions" и "/api/v1/expression/:id" соответственно. При этом пользователю будут выведены только те математические выражения, которые были отправлены на решение под этим же логином. 

Разные пользователи могут одновременно посылать запросы оркестратору, и их обработка будет происходить параллельно. 

По ручке "/api/v1/clear" (добавил от себя) из базы данных будут удалены все данные об отправленных выражениях (короче можно зачистить историю :))) )

## Структура проекта
```
calc_go_final
├── cmd
│   ├── agent
│   │   └── main.go
│   └── orkestrator
│       └── main.go
├── db
│   ├── expressions.db
│   └── store.db
├── env 
│   └── .env
├── internal
│   ├── agent
│   │   ├── config
│   │   │   └── config.go
│   │   └── service
│   │       ├── agent.go
│   │       └── agent_test.go
│   └── orkestrator
│       ├── config
│       │   └── config.go
│       ├── http
│       │   ├── auth.go
│       │   ├── http_test.go
│       │   ├── orkestrator.go
│       │   └── run.go
│       └── service
│           ├── auth_test.go
│           ├── auth.go
│           ├── db_test.go
│           ├── db.go
│           ├── orkestrator_test.go
│           └── orkestrator.go
├── pkg
│   └── models
│       ├── errors.go
│       ├── models.go
│       └── operations.go
├── proto
│   ├── calc_grpc.pb.go
│   ├── calc.pb.go
│   └── calc.proto
├── go.mod
└── go.sum
```

#### cmd
- agent/main.go - запуска сервера агента
- orkestrator/main.go - запуск сервера оркестратора

#### internal/agent - файлы агента
- config/config.go - конфигурирование агента
- service/agent.go - реализация агента

#### internal/orkestrator - файлы оркестратора
- config/config.go - конфигурирование оркестратора
- http:
    - auth.go - хендлеры аутентификации пользователя
    - orkestrator.go - хендлеры оркестратора
    - run.go - создание и запуск сервера
- service:
    - auth.go - функции аутентификации пользователя
    - db.go - функции работы с СУБД выражений
    - orkestrator.go - функции оркестратора

#### env
- .env - переменные среды

#### pkg/models
- errors.go - тексты ошибок
- models.go - структуры
- operations.go - функции создания ID через uuid, преобразования выражения в обратную польскую запись

### proto - прото-файлы

## Переменные среды

Переменные среды и их значения по умолчанию (значения можно изменить в .env):
```
TTIME_ADDITION_MS=3000          #
TIME_SUBTRACTION_MS=3000        # времена выполнения
TIME_MULTIPLICATION_MS=3000     # математических операций
TIME_DIVISION_MS=2000           #

COMPUTING_POWER=1               # количество запускаемых воркеров

PORT_ORKESTRATOR=8081           # порт для запуска http сервера-оркестратора

PORT_AGENT=8080                 # порт для запуска grpc сервера-агента
HOST_AGENT=localhost            # хост для запуска grpc сервера-агента

TABLE_FORMAT=true               # вывод выражений по api/v1/expressions в удобном табличном варианте
```