# Калькулятор на языке Golang

Не смотри на название коммитов, сейчас уже всё работает :)

Калькулятор основан на взаимодействии двух серверов: оркестратора и агента, где оркестратор делит входное математическое выражение на отдельные задачи, а агент эти задачи вычисляет.


## Запуск

1. Клонируйте библиотеку через git clone 

2. Перейдите в папку с программой (calc_go_2.0) в двух cmd-терминалах:
```
cd calc_go_2.0
```

3.  В одном из них введите команду, которая запустит сервер оркестратора:
```
go run cmd/orkestrator/main.go
```

4. В другом введите команду, которая запустит сервер агента:
```
go run cmd/agent/main.go
```

4. Откройте cmd-терминал и введите команду:
```
curl -X POST http://localhost:8081/api/v1/calculate -H "Content-Type:application/json" -d "{\"expression\":\"1+2+3+4+5\"}"
```

6. Для того, чтобы вычислять одновременно два и более выражений, каждое новое следует запускать командой в отдельном терминале (либо, если вычисление предыдущего выражения завершилось - в том же):
```
curl -X POST http://localhost:8081/api/v1/calculate -H "Content-Type:application/json" -d "{\"expression\":\"5-4-3-2-1\"}"
```

7. Чтобы получить все выражения, используйте в отдельном терминале команду:
```
curl -X http://localhost:8081/api/v1/expressions
```

8. Чтобы получить выражение по его ID, используйте команду (вместо id_0 можно вписать любой из имеющихся ID):
```
curl -X http://localhost:8081/api/v1/expression/(любой ID, полученный из expressions)
```

## Примеры запросов
```
curl -X POST http://localhost:8081/api/v1/calculate -H "Content-Type:application/json" -d "{\"expression\":\"1+2+3\"}"
```
Результат: 6

```
curl -X POST http://localhost:8081/api/v1/calculate -H "Content-Type:application/json" -d "{\"expression\":\"1*2+(3+4-5+(6/2))\"}"
```
Результат: 1

```
curl -X POST http://localhost:8081/api/v1/calculate -H "Content-Type:application/json" -d "{\"expression\":\"1+2/0\"}"
```
Результат: деление на ноль

```
curl -X POST http://localhost:8081/api/v1/calculate -H "Content-Type:application/json" -d "{\"expression\":\"1+2+a\"}"
```
Результат: некорректный символ

```
curl -X POST http://localhost:8081/api/v1/calculate -H "Content-Type:application/json" -d "{\"expression\":\"1++2\"}"
```
Результат: некорректное выражение


## Принцип работы

В калькуляторе взаимодействуют пользователь, оркестратор и агент.
[[readme_assets/Scheme.png]]

Оркестратор принимает от пользователя выражение, добавляет его в хранилище, присваивая ID, представляет в виде обратной польской записи. Затем начинается деление выражения на простейшие задачи (задача представлена структурой Task, имеющей поля ID, Status, Arg1, Arg2, Operation, Operation_time, Result, Error). Только что сформированный task отправляется в хранилище задач. Функция деления на задачи уходит в ожидание до тех пор, пока статус у отправленной им задачи не поменяется на "completed".

Всё это время, сразу после запуска сервера агента, он отправляет оркестратору GET-запросы каждые 500 ms (можно изменить в .env), желая получить задачу. При каждом запросе идёт проверка на наличие нерешённых задач (с Status == "need to send") в хранилище задач. Если такие имеются, то агенту выдаётся первая нерешенная задача из стека задач. 

Попав к агенту, задача решается определённым количеством параллельно запущенных воркеров. Их количество задаётся переменной среды COMPUTING_POWER. В калькуляторе имитируются долгие вычисления, поэтому переменными среды задано время выполнения для каждой математической операции. Как только один из воркеров завершит вычисление задачи, останавливается работа всех остальных, а результат (либо ошибка, если таковая обнаружилась в процессе вычисления) отправляется обратно оркестратору. Следующим GET-запросом агент берет следующую нерешённую задачу.

Получив результат, оркестратор изменяет вычисленную задачу в хранилище, добавляя в соответствующие поля результат/ошибку, а также меняет статус на "completed". Функция деления на задачи выходит из режима ожидания и анализирует результаты: если ошибки не возникло - подставляем результат вычислений в следующую задачу, если ошибка всё же возникла - возвращаем её пользователю.

Как только всё выражение будет вычислено без ошибок - выводим результат пользователю.

В процессе работы сервера можно также просмотреть хранилище выражений, и найти выражение по ID с помощью запросов end-поинтами "/api/v1/expressions" и "/api/v1/expression/:id" соответственно.


## Структура проекта
```
calc_go_2.0
├── cmd
│   ├── agent
│   │   └── main.go
│   └── orkestrator
│       └── main.go
├── env 
│   └── .env
├── internal
│   ├── agent
│   │   ├── config
│   │   │   └── config.go
│   │   └── service
│   │       ├── agent.go
│   │       └── agent_test.go
│   └── orkestrator
│       ├── config
│       │   └── config.go
│       ├── http
│       │   └── http.go
│       └── service
│           ├── orkestrator.go
│           └── orkestrator_test.go
├── pkg
│   └── models
│       ├── errors.go
│       ├── models.go
│       └── operations.go
├── go.mod
└── go.sum
```

#### cmd
- agent/main.go - запуска сервера агента
- orkestrator/main.go - запуск сервера оркестратора

#### internal/agent - файлы агента
- config/config.go - конфигурирование агента
- service/agent.go - реализация агента

#### internal/orkestrator - файлы оркестратора
- config/config.go - конфигурирование оркестратора
- http/http.go - реализация хендлеров
- service/orkestrator.go - функции оркестратора (деление выражения на задачи, добавление выражений и задач в хранилище, изменение параметров выражений и задач, получение всех выражений и задач из хранилища)

#### env
- .env - переменные среды

#### pkg/models
- errors.go - тексты ошибок
- models.go - структуры
- operations.go - функции создания ID через uuid, преобразования выражения в обратную польскую запись

## Переменные среды

Переменные среды и их значения по умолчанию (значения можно изменить в .env):
```
TIME_ADDITION_MS=5000          //время выполнения сложения в мс
TIME_SUBTRACTION_MS=6000       //время выполнения вычитания в мс
TIME_MULTIPLICATIONS_MS=7000   //время выполнения умножения в мс
TIME_DIVISIONS_MS=8000         //время выполнения деления в мс

GET_TASK_INTERVAL_MS=500       //интервал, через который агент делает GET-запросы к оркестратору в мс
COMPUTING_POWER=3              //количество запускаемых воркеров

PORT_ORKESTRATOR=8081		   //порт сервера оркестратора
PORT_AGENT=8080				   //порт сервера агента